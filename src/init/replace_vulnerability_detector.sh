#!/bin/bash

# Copyright (C) 2015, Wazuh Inc.
# All rights reserved.
# Wazuh.com

# This program is free software; you can redistribute it
# and/or modify it under the terms of the GNU General Public
# License (version 2) as published by the FSF - Free Software
# Foundation.

# Shell script that updates 'vulnerability-detector' to 'vulnerability-detection'

isVulnerabilityDetectorInstalled()
{
    local OSSEC_CONFIGURATION_FILE="$1"
    local VULNERABILITY_DETECTOR_PATTERN="<vulnerability-detector>"

    if ( grep -q "$VULNERABILITY_DETECTOR_PATTERN" "$OSSEC_CONFIGURATION_FILE" ); then
        return 0
    fi

    return 1
}

updateVulnerabilityDetector()
{
    if [ "$INSTYPE" = "server" ]; then
        local OSSEC_CONFIGURATION_FILE="$1"

        if isVulnerabilityDetectorInstalled "$OSSEC_CONFIGURATION_FILE"; then 
            local OSSEC_CONFIGURATION_FILE_TMP="$1.tmp"
            local VULN_TEMPLATE="./etc/templates/config/generic/wodle-vulnerability-detection.manager.template"
            local INDEXER_TEMPLATE="./etc/templates/config/generic/wodle-indexer.manager.template"

            touch $OSSEC_CONFIGURATION_FILE_TMP

            local OSSEC_CONFIGURATION_FILE_BEFORE_VD="$(sed -ne '/<vulnerability-detector>/q;p' $OSSEC_CONFIGURATION_FILE)"
            local OSSEC_CONFIGURATION_FILE_AFTER_VD="$(sed -e '1,/<\/vulnerability-detector>/d' $OSSEC_CONFIGURATION_FILE)"

            # OSSEC_CONFIGURATION_FILE_BEFORE_VD
            printf "%s\n\n" "${OSSEC_CONFIGURATION_FILE_BEFORE_VD}" >> $OSSEC_CONFIGURATION_FILE_TMP
            printf "\n" >> $OSSEC_CONFIGURATION_FILE_TMP

            # Vulnerability Detection
            cat ${VULN_TEMPLATE} >> $OSSEC_CONFIGURATION_FILE_TMP
            printf "\n" >> $OSSEC_CONFIGURATION_FILE_TMP

            # Indexer
            cat ${INDEXER_TEMPLATE} >> $OSSEC_CONFIGURATION_FILE_TMP
            printf "\n" >> $OSSEC_CONFIGURATION_FILE_TMP

            # OSSEC_CONFIGURATION_FILE_AFTER_VD
            printf "%s\n\n" "$OSSEC_CONFIGURATION_FILE_AFTER_VD" >> $OSSEC_CONFIGURATION_FILE_TMP
            printf "\n" >> $OSSEC_CONFIGURATION_FILE_TMP

            mv $OSSEC_CONFIGURATION_FILE_TMP $OSSEC_CONFIGURATION_FILE
        fi
    fi
}
