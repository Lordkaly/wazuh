#ifndef __SEND_REPORT_HPP
#define __SEND_REPORT_HPP

#include "chainOfResponsability.hpp"
#include "loggerHelper.h"
#include "scanContext.hpp"
#include "socketClient.hpp"
#include "vulnerabilityScanner.hpp"

const std::string LOCALFILE_MQ {"1"};
extern int SOCKET_WAIT;

/**
 * @brief Class in charge to send formatted report messages.
 *
 */
class SendReport final : public AbstractHandler<std::shared_ptr<ScanContext>>
{
private:
    std::shared_ptr<SocketClient<Socket<OSPrimitives, NoHeaderProtocol>, EpollWrapper>> m_reportSocketClient;

public:
    // LCOV_EXCL_START
    /**
     * @brief Construct a new Send Report object
     *
     * @param reportSocketClient Socket client instance.
     */
    explicit SendReport(
        std::shared_ptr<SocketClient<Socket<OSPrimitives, NoHeaderProtocol>, EpollWrapper>> reportSocketClient)
        : m_reportSocketClient(reportSocketClient)
    {
    }

    /**
     * @brief Handles request and passes control to the next step of the chain.
     *
     * @param data Scan context.
     * @return std::shared_ptr<ScanContext> Abstract handler.
     */
    std::shared_ptr<ScanContext> handleRequest(std::shared_ptr<ScanContext> data) override
    {
        for (const auto& [key, value] : data->m_alerts)
        {
            try
            {
                std::ostringstream oss;

                // 1:[001] (agent_name) ip->location:
                oss << LOCALFILE_MQ << ":"
                    << "[" << std::string(data->agentId()) << "] (" << std::string(data->agentName()) << ") "
                    << std::string(data->agentIp()) << "->"
                    << "vulnerability-detector"
                    << ":"
                    // Vulnerability report.
                    << value.dump().c_str();

                const std::string message = oss.str();
                logDebug2(WM_VULNSCAN_LOGTAG,
                          "Vulnerability %s report: %s",
                          data->getType() == ScannerType::PackageInsert   ? "detected"
                          : data->getType() == ScannerType::PackageDelete ? "solved"
                                                                          : "clear",
                          message.c_str());
                m_reportSocketClient->send(message.c_str(), message.size());

                std::this_thread::sleep_for(std::chrono::microseconds(SOCKET_WAIT));
            }
            catch (...)
            {
                logWarn(WM_VULNSCAN_LOGTAG, "Couldn't send vulnerability JSON report for %s:", key.c_str());
            }
        }

        if (data->m_elements.empty())
        {
            return nullptr;
        }

        return AbstractHandler<std::shared_ptr<ScanContext>>::handleRequest(data);
    }
    // LCOV_EXCL_STOP
};

#endif // __SEND_REPORT_HPP
